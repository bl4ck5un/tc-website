<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Understand the Town Crier contract &#8212; Town Crier 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to Town Crier: an Authenticated Data Feed for Smart Contracts’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="understand-the-town-crier-contract">
<h1>Understand the <code class="docutils literal"><span class="pre">Town</span> <span class="pre">Crier</span></code> contract<a class="headerlink" href="#understand-the-town-crier-contract" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal"><span class="pre">TownCrier</span></code> contract provides a uniform interface for queries from and replies to an application contract, which we also refer as a &#8220;Requester&#8221;.
This interface consists of the following three functions.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">request</span><span class="p">(</span><span class="nx">uint8</span> <span class="nx">requestType</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">callbackAddr</span><span class="p">,</span> <span class="o">\</span>
      <span class="nx">bytes4</span> <span class="nx">callbackFID</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="o">\</span>
      <span class="nx">bytes32</span><span class="p">[]</span> <span class="nx">requestData</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="nx">returns</span><span class="p">(</span><span class="nx">uint64</span><span class="p">);</span>
</pre></div>
</div>
<p>An application contract sends queries to TC by calling function <code class="docutils literal"><span class="pre">request()</span></code>, and it needs to send the following parameters.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">requestType</span></code>: indicates the query type. You can find the query types and respective formats that Town Crier currently supports on the Dev page.</li>
<li><code class="docutils literal"><span class="pre">callbackAddr</span></code>: the address of the application contract to which the response from Town Crier is forwarded.</li>
<li><code class="docutils literal"><span class="pre">callbackFID</span></code>: specifies the callback function in the application contract to receive the response from TC.</li>
<li><code class="docutils literal"><span class="pre">timestamp</span></code>: currently unused parameter. This parameter will be used in a future feature. Currently TC only responds to requests immediately. Eventually TC will support requests with a future query time pre-specified by <code class="docutils literal"><span class="pre">timestamp</span></code>. At present, developers can ignore this parameter and just set it to 0.</li>
<li><code class="docutils literal"><span class="pre">requestData</span></code>: data specifying query parameters. The format depends on the query type.</li>
</ul>
<p>When the <code class="docutils literal"><span class="pre">request</span></code> function is called, a request is logged by event <code class="docutils literal"><span class="pre">RequestInfo()</span></code>.
The function returns a <code class="docutils literal"><span class="pre">requestId</span></code> that is uniquely assigned to this request.
The application contract can use the <code class="docutils literal"><span class="pre">requestId</span></code> to check the response or status of a request in its logs.
The Town Crier server watches events and processes a request once logged by <code class="docutils literal"><span class="pre">RequestInfo()</span></code>.</p>
<p>Requesters must prepay the gas cost incurred by the Town Crier server in relaying a response to the application contract.
<code class="docutils literal"><span class="pre">msg.value</span></code> is the amount of wei a requester pays and is recorded as <code class="docutils literal"><span class="pre">Request.fee</span></code>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">deliver</span><span class="p">(</span><span class="nx">uint64</span> <span class="nx">requestId</span><span class="p">,</span> <span class="nx">bytes32</span> <span class="nx">paramsHash</span><span class="p">,</span> <span class="nx">uing64</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">bytes32</span> <span class="nx">respData</span><span class="p">)</span> <span class="kr">public</span><span class="p">;</span>
</pre></div>
</div>
<p>After fetching data and generating the response for the request with <code class="docutils literal"><span class="pre">requestId</span></code>, TC sends a transaction calling function <code class="docutils literal"><span class="pre">deliver()</span></code>.
<code class="docutils literal"><span class="pre">deliver()</span></code> verifies that the function call is made by SGX and that the hash of query parameters is correct.
Then it calls the callback function of the application contract to transmit the response.</p>
<p>The response includes <code class="docutils literal"><span class="pre">error</span></code> and <code class="docutils literal"><span class="pre">respData</span></code>.
If <code class="docutils literal"><span class="pre">error</span> <span class="pre">=</span> <span class="pre">0</span></code>, the application contract request has been successfully processed and the application contract can then safely use <code class="docutils literal"><span class="pre">respData</span></code>.
The fee paid by the application contract for the request is consumed by TC.
If <code class="docutils literal"><span class="pre">error</span> <span class="pre">=</span> <span class="pre">1</span></code>, the application contract request is invalid or cannot be found on the website.
In this case, similarly, the fee is consumed by TC.
If <code class="docutils literal"><span class="pre">error</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>, then an error has occured in the Town Crier server.
In this case, the fee is fully refunded but the transaction cost for requesting by the application contract won&#8217;t be compensated.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">cancel</span><span class="p">(</span><span class="nx">uint64</span> <span class="nx">requestId</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">returns</span><span class="p">(</span><span class="nx">bool</span><span class="p">);</span>
</pre></div>
</div>
<p>A requester can cancel a request whose response has not yet been issued by calling function <code class="docutils literal"><span class="pre">cancel()</span></code>.
<code class="docutils literal"><span class="pre">requestId</span></code> is required to specify the query.
The fee paid by the Appliciation Contract is then refunded (minus processing costs, denoted as cancellation fee).</p>
<p>For more details, you can look at the source code of the contract [TownCrier.sol].</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to Town Crier: an Authenticated Data Feed for Smart Contracts&#8217;s documentation!</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/tc-contract.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Fan Zhang.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/tc-contract.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>